name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 50.18.129.148
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          echo "ğŸš€ Starting deployment at $(date)"
          echo "================================"
          
          # Navigate to project directory
          echo "ğŸ“ Navigating to project directory..."
          cd /home/ec2-user/designer-konva || { echo "âŒ ERROR: Directory /home/ec2-user/designer-konva not found"; exit 1; }
          echo "âœ… Current directory: $(pwd)"
          
          # Git pull with conflict resolution
          echo ""
          echo "ğŸ“¥ Pulling latest changes..."
          echo "Current git status:"
          git status --short
          
          # Reset package-lock.json if it has local changes
          if git status --porcelain | grep -q "package-lock.json"; then
            echo "âš ï¸  Resetting package-lock.json to avoid conflicts..."
            git checkout -- package-lock.json
          fi
          
          git pull origin main 2>&1 || { 
            echo "âŒ ERROR: Git pull failed with exit code $?"
            echo "Attempting to reset and pull..."
            git fetch origin
            git reset --hard origin/main
          }
          echo "âœ… Git pull successful"
          
          # Install dependencies
          echo ""
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --production=false 2>&1 || { echo "âŒ ERROR: npm ci failed with exit code $?"; exit 1; }
          echo "âœ… Dependencies installed"
          
          # Set environment variables
          echo ""
          echo "ğŸ”§ Setting environment variables..."
          export SHOPIFY_APP_URL=https://app.printlabs.com
          export NODE_ENV=production
          echo "âœ… Environment variables set"
          
          # Build
          echo ""
          echo "ğŸ”¨ Building the app..."
          npm run build 2>&1 || { echo "âŒ ERROR: Build failed with exit code $?"; exit 1; }
          echo "âœ… Build successful"
          
          # Database setup
          echo ""
          echo "ğŸ—„ï¸  Running database migrations..."
          npm run setup 2>&1 || { echo "âŒ ERROR: Database setup failed with exit code $?"; exit 1; }
          echo "âœ… Database setup complete"
          
          # PM2 restart
          echo ""
          echo "ğŸ”„ Restarting PM2..."
          pm2 reload ecosystem.config.cjs --update-env 2>&1 || { echo "âŒ ERROR: PM2 reload failed with exit code $?"; exit 1; }
          pm2 save
          echo "âœ… PM2 restarted"
          
          echo ""
          echo "ğŸ“Š PM2 Status:"
          pm2 list
          
          echo ""
          echo "================================"
          echo "âœ… Deployment complete at $(date)!"