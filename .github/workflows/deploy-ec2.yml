name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 50.18.129.148
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          echo "ğŸš€ Starting deployment at $(date)"
          echo "================================"

          # Navigate to project directory
          echo "ğŸ“ Navigating to project directory..."
          cd /home/ec2-user/designer-konva || { echo "âŒ ERROR: Directory /home/ec2-user/designer-konva not found"; exit 1; }
          echo "âœ… Current directory: $(pwd)"

          # Git pull with conflict resolution
          echo ""
          echo "ğŸ“¥ Pulling latest changes..."
          echo "Current git status:"
          git status --short

          # Reset package-lock.json if it has local changes
          if git status --porcelain | grep -q "package-lock.json"; then
            echo "âš ï¸  Resetting package-lock.json to avoid conflicts..."
            git checkout -- package-lock.json
          fi

          # Clean git state and pull
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          echo "âœ… Git state cleaned and updated"

          # Install dependencies
          echo ""
          echo "ğŸ“¦ Installing dependencies..."
          rm -rf node_modules
          rm -f package-lock.json
          npm install --production=false 2>&1 || { echo "âŒ ERROR: npm install failed with exit code $?"; exit 1; }
          echo "âœ… Dependencies installed"

          # Set environment variables
          echo ""
          echo "ğŸ”§ Setting environment variables..."
          export SHOPIFY_APP_URL=https://app.printlabs.com
          export NODE_ENV=production
          echo "âœ… Environment variables set"

          # Build
          echo ""
          echo "ğŸ”¨ Building the app..."
          rm -rf build
          rm -rf public/build
          npm run build 2>&1 || { echo "âŒ ERROR: Build failed with exit code $?"; exit 1; }
          echo "âœ… Build successful"

          # Database setup
          echo ""
          echo "ğŸ—„ï¸  Running database migrations..."
          # The .env file on EC2 already has the correct DATABASE_URL
          # Prisma will automatically load it from .env
          npm run setup 2>&1 || { echo "âŒ ERROR: Database setup failed with exit code $?"; exit 1; }
          echo "âœ… Database setup complete"

          # PM2 restart
          echo ""
          echo "ğŸ”„ Restarting PM2..."
          pm2 delete all || true
          pm2 start ecosystem.config.cjs --update-env 2>&1 || { echo "âŒ ERROR: PM2 start failed with exit code $?"; exit 1; }
          pm2 save
          echo "âœ… PM2 restarted"

          echo ""
          echo "ğŸ“Š PM2 Status:"
          pm2 list

          echo ""
          echo "================================"
          echo "âœ… Deployment complete at $(date)!"